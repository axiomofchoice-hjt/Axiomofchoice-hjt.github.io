<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>思想实验：让 Python 拥有 C 的性能 | Axiomofchoice&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <link rel="alternate" type="application/rss+xml" href="https://axiomofchoice-hjt.github.io/rss.xml" title="Axiomofchoice&#39;s Blog RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://axiomofchoice-hjt.github.io/feed.atom" title="Axiomofchoice&#39;s Blog Atom Feed">
    <link rel="alternate" type="application/json" href="https://axiomofchoice-hjt.github.io/feed.json" title="Axiomofchoice&#39;s Blog JSON Feed">
    <meta name="description" content="性能杂谈">
    
    <link rel="preload" href="/assets/css/0.styles.42f00b7f.css" as="style"><link rel="preload" href="/assets/js/app.307dbf8f.js" as="script"><link rel="preload" href="/assets/js/3.5c8ee2be.js" as="script"><link rel="preload" href="/assets/js/2.fad8e389.js" as="script"><link rel="preload" href="/assets/js/40.8121dfcd.js" as="script"><link rel="prefetch" href="/assets/js/1.1c74aad9.js"><link rel="prefetch" href="/assets/js/10.32679d8b.js"><link rel="prefetch" href="/assets/js/11.35d446f7.js"><link rel="prefetch" href="/assets/js/12.50689bf5.js"><link rel="prefetch" href="/assets/js/13.18f232cf.js"><link rel="prefetch" href="/assets/js/14.8218e3d5.js"><link rel="prefetch" href="/assets/js/15.f52ebd01.js"><link rel="prefetch" href="/assets/js/16.e759f590.js"><link rel="prefetch" href="/assets/js/17.12c98fdd.js"><link rel="prefetch" href="/assets/js/18.591e5a6f.js"><link rel="prefetch" href="/assets/js/19.e52a3c53.js"><link rel="prefetch" href="/assets/js/20.7f307c58.js"><link rel="prefetch" href="/assets/js/21.20b4db9a.js"><link rel="prefetch" href="/assets/js/22.2ed55c0b.js"><link rel="prefetch" href="/assets/js/23.4d138647.js"><link rel="prefetch" href="/assets/js/24.928357a5.js"><link rel="prefetch" href="/assets/js/25.be4e152a.js"><link rel="prefetch" href="/assets/js/26.1b9ccd3a.js"><link rel="prefetch" href="/assets/js/27.49aa815f.js"><link rel="prefetch" href="/assets/js/28.78a3006f.js"><link rel="prefetch" href="/assets/js/29.4122373f.js"><link rel="prefetch" href="/assets/js/30.4bc599e1.js"><link rel="prefetch" href="/assets/js/31.5725faab.js"><link rel="prefetch" href="/assets/js/32.715f43b9.js"><link rel="prefetch" href="/assets/js/33.189ae481.js"><link rel="prefetch" href="/assets/js/34.88543860.js"><link rel="prefetch" href="/assets/js/35.b282ff24.js"><link rel="prefetch" href="/assets/js/36.eb302533.js"><link rel="prefetch" href="/assets/js/37.05ffbda3.js"><link rel="prefetch" href="/assets/js/38.29066f10.js"><link rel="prefetch" href="/assets/js/39.f6f1464c.js"><link rel="prefetch" href="/assets/js/4.f9729f4e.js"><link rel="prefetch" href="/assets/js/41.63d8a15b.js"><link rel="prefetch" href="/assets/js/42.e137766a.js"><link rel="prefetch" href="/assets/js/43.c7d0f880.js"><link rel="prefetch" href="/assets/js/44.f0e2ac56.js"><link rel="prefetch" href="/assets/js/45.75f57bf0.js"><link rel="prefetch" href="/assets/js/46.f13f1c7a.js"><link rel="prefetch" href="/assets/js/47.dede8c3e.js"><link rel="prefetch" href="/assets/js/48.a8c59062.js"><link rel="prefetch" href="/assets/js/49.4beae624.js"><link rel="prefetch" href="/assets/js/5.0fee6bc0.js"><link rel="prefetch" href="/assets/js/50.b8ac5a19.js"><link rel="prefetch" href="/assets/js/51.cf7724c3.js"><link rel="prefetch" href="/assets/js/52.0b89a331.js"><link rel="prefetch" href="/assets/js/53.cc3915be.js"><link rel="prefetch" href="/assets/js/54.a94f990b.js"><link rel="prefetch" href="/assets/js/55.b7e0819d.js"><link rel="prefetch" href="/assets/js/56.630cac69.js"><link rel="prefetch" href="/assets/js/57.e140d303.js"><link rel="prefetch" href="/assets/js/58.c0067cdf.js"><link rel="prefetch" href="/assets/js/59.a8d29935.js"><link rel="prefetch" href="/assets/js/6.26798248.js"><link rel="prefetch" href="/assets/js/60.f059368d.js"><link rel="prefetch" href="/assets/js/61.a0ab9393.js"><link rel="prefetch" href="/assets/js/62.4db87a18.js"><link rel="prefetch" href="/assets/js/63.818187b8.js"><link rel="prefetch" href="/assets/js/64.184949d9.js"><link rel="prefetch" href="/assets/js/65.6ebb1331.js"><link rel="prefetch" href="/assets/js/66.8bdcf1a3.js"><link rel="prefetch" href="/assets/js/67.08c4ccc2.js"><link rel="prefetch" href="/assets/js/68.647d068d.js"><link rel="prefetch" href="/assets/js/69.8ca5b277.js"><link rel="prefetch" href="/assets/js/70.4422c51a.js"><link rel="prefetch" href="/assets/js/71.6b02db80.js"><link rel="prefetch" href="/assets/js/72.2e33f35b.js"><link rel="prefetch" href="/assets/js/73.9597206d.js"><link rel="prefetch" href="/assets/js/74.163989d1.js"><link rel="prefetch" href="/assets/js/75.65fbb5a9.js"><link rel="prefetch" href="/assets/js/76.72e8b154.js"><link rel="prefetch" href="/assets/js/77.b2493f39.js"><link rel="prefetch" href="/assets/js/78.20e27043.js"><link rel="prefetch" href="/assets/js/79.576e75c0.js"><link rel="prefetch" href="/assets/js/80.7eb11e82.js"><link rel="prefetch" href="/assets/js/81.848e4415.js"><link rel="prefetch" href="/assets/js/82.2d5cd732.js"><link rel="prefetch" href="/assets/js/83.c466f209.js"><link rel="prefetch" href="/assets/js/84.20c6e071.js"><link rel="prefetch" href="/assets/js/85.a5d1a6f0.js"><link rel="prefetch" href="/assets/js/9.1c912b3c.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.765af30c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.42f00b7f.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/favicon.ico" alt="Axiomofchoice's Blog" class="logo"> <span class="site-name can-hide">Axiomofchoice's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><a href="https://axiomofchoice-hjt.pages.dev/puzzles/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  puzzles
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://underdog-daily.pages.dev/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  败犬日报
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/axiomofchoice-hjt/blogpages" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/favicon.ico"> <div class="blogger-info"><h3>Axiomofchoice</h3> <span>C++ / HPC / Algorithm</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><a href="https://axiomofchoice-hjt.pages.dev/puzzles/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  puzzles
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://underdog-daily.pages.dev/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  败犬日报
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/axiomofchoice-hjt/blogpages" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/aca146/" aria-current="page" class="active sidebar-link">思想实验：让 Python 拥有 C 的性能</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/aca146/#_1-前言" class="sidebar-link">1. 前言</a></li><li class="sidebar-sub-header level2"><a href="/pages/aca146/#_2-虚拟机开销" class="sidebar-link">2. 虚拟机开销</a></li><li class="sidebar-sub-header level2"><a href="/pages/aca146/#_3-运行时类型信息" class="sidebar-link">3. 运行时类型信息</a></li><li class="sidebar-sub-header level2"><a href="/pages/aca146/#_4-解引用开销" class="sidebar-link">4. 解引用开销</a></li><li class="sidebar-sub-header level2"><a href="/pages/aca146/#_5-gc-开销" class="sidebar-link">5. GC 开销</a></li><li class="sidebar-sub-header level2"><a href="/pages/aca146/#_6-动态属性开销" class="sidebar-link">6. 动态属性开销</a></li><li class="sidebar-sub-header level2"><a href="/pages/aca146/#_7-一些细节" class="sidebar-link">7. 一些细节</a></li><li class="sidebar-sub-header level2"><a href="/pages/aca146/#_8-总结" class="sidebar-link">8. 总结</a></li></ul></li><li><a href="/pages/04ae8d/" class="sidebar-link">用汇编分析一下各种交换方法的性能</a></li><li><a href="/pages/5d5a89/" class="sidebar-link">卡常：关于对常量取模的优化</a></li><li><a href="/pages/c1e151/" class="sidebar-link">浮点数误差入门</a></li><li><a href="/pages/85c4ed/" class="sidebar-link">集合求并的极致优化</a></li><li><a href="/pages/86fdbe/" class="sidebar-link">xbyak 汇编开发姿势</a></li><li><a href="/pages/1abfb8/" class="sidebar-link">如何做好 benchmark</a></li><li><a href="/pages/f2fc10/" class="sidebar-link">更自由的 perf 采样实践</a></li><li><a href="/pages/62c8f3/" class="sidebar-link">测量多线程每个线程的运行时间</a></li><li><a href="/pages/22df72/" class="sidebar-link">用户态线程同步</a></li><li><a href="/pages/f78cb0/" class="sidebar-link">SME 指令集使用指南</a></li><li><a href="/pages/1d919a/" class="sidebar-link">浮点数条件运算的性能分析</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96" title="分类" data-v-06225672>性能优化</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/axiomofchoice-hjt" target="_blank" title="作者" class="beLink" data-v-06225672>Axiomofchoice</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-03-25</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">思想实验：让 Python 拥有 C 的性能<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="_1-前言"><a href="#_1-前言" class="header-anchor">#</a> 1. 前言</h2> <p>最近我在想一个问题，既然语言的性能和它的编译器 / 解释器有很大的关系，那么是不是对于任何语言，经过适当优化，配上一个完美的编译器，都可以拥有 C 的性能？</p> <p>所以我打算做一个，如何让 Python 拥有 C 的性能的思想实验。（口嗨罢了，事实上是有人做过这方面的努力的，而且是实际行动上）</p> <h2 id="_2-虚拟机开销"><a href="#_2-虚拟机开销" class="header-anchor">#</a> 2. 虚拟机开销</h2> <p>众所周知，Python 是一个脚本语言，脚本语言和物理机之间隔了一层虚拟机。那么如何去掉这层虚拟机呢？答案当然是用编译器了。（这里的编译器指编译到机器码的编译器）</p> <h2 id="_3-运行时类型信息"><a href="#_3-运行时类型信息" class="header-anchor">#</a> 3. 运行时类型信息</h2> <p>Python 是一个动态类型语言，我们可以任意修改变量的类型，这意味着我们可能无法在编译时确定变量的类型。</p> <p>例如下面这段程序运行完后，鬼才知道 x 最终类型是 <code>int</code> 还是 <code>float</code>：</p> <div class="language-py extra-class"><pre class="language-py"><code>x <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">if</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">:</span>
    x <span class="token operator">=</span> <span class="token number">0.1</span>
</code></pre></div><p>那么不确定变量类型有什么问题呢？</p> <p>第一个影响是，每个值都额外需要一个类型信息，读取这个类型信息是有开销的。</p> <p>第二个影响是编译器 / 解释器做不到对类型未知的变量进行优化。一个简单的例子是，如果 x 是无符号整型，那么 <code>x *= 2</code> 可以优化为 <code>x &lt;&lt;= 1</code>。</p> <p>所以我的解决方法是，让编译器读取类型标注（typing），并对违反类型标注的行为报 warning。</p> <div class="language-py extra-class"><pre class="language-py"><code>x<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">if</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">:</span>
    x <span class="token operator">=</span> <span class="token number">0.1</span>  <span class="token comment"># warning</span>
</code></pre></div><h2 id="_4-解引用开销"><a href="#_4-解引用开销" class="header-anchor">#</a> 4. 解引用开销</h2> <p>Python 的所有变量都是放在堆上的。解引用开销，其实就是每次访问一个变量都要通过引用（指针）间接地访问，相比于直接访问肯定是慢一点了。</p> <p>我们知道，变量防在栈上的一个要求就是，这个变量是定长的（字节数固定）。这个好办，由于我们刚刚确定了变量的类型，定长也就呼之欲出了。（这里不包括 <code>list</code> 等不定长类型）</p> <h2 id="_5-gc-开销"><a href="#_5-gc-开销" class="header-anchor">#</a> 5. GC 开销</h2> <p>什么是 GC（Garbage Collection, 垃圾回收）？就是指一个变量诞生在堆上后，不需要人为把它释放掉，GC 来帮我们释放。</p> <p>这个东西给程序员提供了很大的便利，只可惜我的目标是把 Python 优化成 C，因此这个“完美的编译器”必须在一定条件下编译出不带 GC 的程序。</p> <p>受 C++ 的 RAII 和 Rust 所有权机制的影响，我觉得可以通过约束程序员的代码来实现所有权。</p> <ol><li>一个数据被一个变量独占（即所有权）</li> <li>用弱引用（<code>weakref</code>）来实现借用</li> <li>移动语义可以这么写：<code>a = b; del b;</code></li> <li>一个数据离开作用域后被释放（在 Python 中是函数作用域）</li></ol> <p>我要求，如果一个程序严格遵循 RAII，那么编译器必须编译出无 GC 的程序；反之编译器编译出带 GC 的程序。（这个编译器太智能了）</p> <h2 id="_6-动态属性开销"><a href="#_6-动态属性开销" class="header-anchor">#</a> 6. 动态属性开销</h2> <p>Python 允许对象动态添加、删除属性。为了实现动态属性，其实对象内置了一个哈希表（<code>__dict__</code>）。</p> <p>哈希表的开销不言而喻。我们首先要声明对象的 <code>__slots__</code>，这样禁止了添加属性的行为。其次只能用 <code>foo.bar</code> 的方式访问属性，这样给了编译器优化的空间，优化成 C 不是梦想。</p> <p>既然说到对象，继承也很有问题，不过这方面我了解太少就略过了。（有一说一，C 语言没有继承，要不把这个功能砍了？）</p> <h2 id="_7-一些细节"><a href="#_7-一些细节" class="header-anchor">#</a> 7. 一些细节</h2> <p>之前说的其实都是“大道理”，在细节上还需要的优化太多了。</p> <p>第一个是 <code>int</code> 是没有范围的，相比与 C 的 32 位整数来说，是有一定开销的。因此为了让 <code>int</code> 装作自己是 32 位整数，可以让它每次修改后断言一下。</p> <div class="language-py extra-class"><pre class="language-py"><code>x<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> x <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">31</span><span class="token punctuation">)</span>
x <span class="token operator">+=</span> <span class="token number">10</span>
<span class="token keyword">assert</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> x <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">31</span><span class="token punctuation">)</span>
</code></pre></div><p>这段话就基本等价于 C 语言的：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token class-name">int32_t</span> x<span class="token punctuation">;</span>
<span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">&quot;%d&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
x <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre></div><p>第二个是定长的数组，这个很好办，只要在初始化之后不出现修改数组长度的操作即可。</p> <p>第三个是 Python 定义了很多异常，而在 C 里很多属于未定义行为（比如数组越界），不得不背离 Python 标准来提高性能了。</p> <h2 id="_8-总结"><a href="#_8-总结" class="header-anchor">#</a> 8. 总结</h2> <p>写了好多，大致理了一遍脚本语言和 C/C++ 的区别。</p> <p>经过一系列改造，Python 也许就能有 C 的性能了。不过就算有这么一个“完美的编译器”，直接上 C++/Rust 等语言它不香吗？</p> <p>以上。</p></div></div> <!----> <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/pages/04ae8d/">用汇编分析一下各种交换方法的性能</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:axiomofchoice@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://qm.qq.com/q/o2qw5F5Gp4" title="QQ" target="_blank" class="iconfont icon-QQ"></a><a href="https://github.com/axiomofchoice-hjt" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://axiomofchoice-hjt.github.io/rss.xml" title="RSS" target="_blank" class="iconfont icon-rss"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2026
    <span>Axiomofchoice | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.307dbf8f.js" defer></script><script src="/assets/js/3.5c8ee2be.js" defer></script><script src="/assets/js/2.fad8e389.js" defer></script><script src="/assets/js/40.8121dfcd.js" defer></script>
  </body>
</html>
