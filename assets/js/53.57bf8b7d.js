(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{474:function(t,s,a){"use strict";a.r(s);var e=a(17),i=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("最近在做大模型 MoE 负载均衡的优化。本来同事做了很多工作了，但是效果不理想，峰均比 1.7。")]),t._v(" "),s("p",[t._v("我拿到任务，检查了测试集和代码，测试集和平均值的 KL 散度已经很低了（小于 0.05，说明数据相关性很高），但峰均比还是 1.7，看起来很反直觉。")]),t._v(" "),s("p",[t._v("于是问了 GPT。")]),t._v(" "),s("p",[t._v("GPT 解释了 KL 散度衡量的是均匀性，峰均比衡量极值，前者不能反应后者。同时总结了峰均比公式 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",[s("semantics",[s("mrow",[s("mtext",[s("mi",{attrs:{mathvariant:"normal"}},[t._v("P")]),s("mi",{attrs:{mathvariant:"normal"}},[t._v("A")]),s("mi",{attrs:{mathvariant:"normal"}},[t._v("P")]),s("mi",{attrs:{mathvariant:"normal"}},[t._v("R")])],1),s("mo",[t._v("=")]),s("mn",[t._v("1")]),s("mo",[t._v("+")]),s("msqrt",[s("mrow",[s("mfrac",[s("mrow",[s("mn",[t._v("2")]),s("mi",[t._v("N")]),s("mi",[t._v("log")]),s("mi",[t._v("N")])],1),s("mrow",[s("mi",[t._v("T")])],1)],1)],1)],1)],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("\\text{PAPR}=1+\\sqrt{\\frac{2N\\log N}{T}}")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"strut",staticStyle:{height:"1.278618em"}}),s("span",{staticClass:"strut bottom",staticStyle:{height:"1.84002em","vertical-align":"-0.561402em"}}),s("span",{staticClass:"base textstyle uncramped"},[s("span",{staticClass:"text mord textstyle uncramped"},[s("span",{staticClass:"mord mathrm"},[t._v("P")]),s("span",{staticClass:"mord mathrm"},[t._v("A")]),s("span",{staticClass:"mord mathrm"},[t._v("P")]),s("span",{staticClass:"mord mathrm"},[t._v("R")])]),s("span",{staticClass:"mrel"},[t._v("=")]),s("span",{staticClass:"mord mathrm"},[t._v("1")]),s("span",{staticClass:"mbin"},[t._v("+")]),s("span",{staticClass:"sqrt mord"},[s("span",{staticClass:"sqrt-sign",staticStyle:{top:"-0.08861800000000009em"}},[s("span",{staticClass:"style-wrap reset-textstyle textstyle uncramped"},[s("span",{staticClass:"delimsizing size2"},[t._v("√")])])]),s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"0em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"1em"}},[t._v("​")])]),s("span",{staticClass:"mord textstyle cramped"},[s("span",{staticClass:"mord reset-textstyle textstyle cramped"},[s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"}),s("span",{staticClass:"mfrac"},[s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"0.345em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle cramped"},[s("span",{staticClass:"mord scriptstyle cramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("T")])])])]),s("span",{staticStyle:{top:"-0.22999999999999998em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle uncramped frac-line"})]),s("span",{staticStyle:{top:"-0.44610799999999995em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle cramped"},[s("span",{staticClass:"mord scriptstyle cramped"},[s("span",{staticClass:"mord mathrm"},[t._v("2")]),s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.10903em"}},[t._v("N")]),s("span",{staticClass:"mop"},[t._v("lo"),s("span",{staticStyle:{"margin-right":"0.01389em"}},[t._v("g")])]),s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.10903em"}},[t._v("N")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"})])])]),s("span",{staticStyle:{top:"-1.198618em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"1em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle uncramped sqrt-line"})]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"1em"}},[t._v("​")])]),t._v("​")])])])])])]),t._v("，N 是 rank 数，T 是分发的总 token 数，算出来 1.7 就是理论值。")]),t._v(" "),s("p",[t._v("这个公式确实有点说法，拟合得很好，但我数学不好看不懂为什么。")]),t._v(" "),s("p",[t._v("而且我们一开始方向就不对，我们一直想办法增加物理专家数，公式却告诉我们这个影响不大。")]),t._v(" "),s("p",[t._v("这也算是一次知识欠缺导致的踩坑经历吧。")])])}),[],!1,null,null,null);s.default=i.exports}}]);